<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Hazard Explorer - Mobile Ready</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
html, body, #map { height:100%; margin:0; background:#000; overflow: hidden; }

/* Control Panel Base */
.control {
    position:absolute; top:10px; left:10px; z-index:10;
    background:rgba(255,255,255,0.95); border-radius:12px;
    font:13px/1.4 system-ui, -apple-system, sans-serif;
    width:280px; box-shadow:0 4px 20px rgba(0,0,0,0.3);
    transition: all 0.3s ease; display: flex; flex-direction: column;
}

/* Header/Toggle Area */
.control-header {
    padding: 12px 15px; display: flex; justify-content: space-between;
    align-items: center; cursor: pointer; border-bottom: 1px solid transparent;
}
.control-header b { font-size: 15px; color: #222; }
.minimize-icon { font-size: 18px; font-weight: bold; color: #666; transition: transform 0.3s; }

/* Collapsible Content */
.control-content {
    padding: 0 15px 15px 15px; overflow-y: auto; max-height: 80vh;
}

/* Minimized State */
.control.minimized { width: 200px; }
.control.minimized .control-content { display: none; }
.control.minimized .minimize-icon { transform: rotate(180deg); }
.control.minimized .control-header { border-bottom: none; }

/* Form Elements */
.section-title { font-weight:bold; color:#444; display:block; margin-top:12px; }
select, input { 
    width:100%; margin-top:5px; padding:8px; border:1px solid #ccc; 
    border-radius:6px; font-size:14px; box-sizing:border-box;
}
input[type="range"] { padding: 0; }

.legend-grid { display:grid; grid-template-columns:22px 1fr; gap:6px 10px; margin-top:10px; }
.swatch { width:22px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,0.1); }
.slider-label { display:flex; justify-content:space-between; margin-top:15px; font-weight:bold; color:#444; }

/* Mobile Optimizations */
@media (max-width: 480px) {
    .control { width: calc(100% - 20px); top: 10px; left: 10px; }
    .control.minimized { width: 160px; }
    .control-header b { font-size: 13px; }
    .section-title { margin-top: 8px; }
}
</style>
</head>
<body>

<div id="map"></div>

<div class="control" id="controlPanel">
    <div class="control-header" onclick="toggleMinimize()">
        <b>Hazard Explorer</b>
        <span class="minimize-icon" id="minBtn">−</span>
    </div>
    
    <div class="control-content">
        <label class="section-title">Return Period:</label>
        <select id="returnPeriod"></select>

        <label class="section-title">Landslide Area (sqm):</label>
        <input type="number" id="userArea" value="0" step="0.1" min="0">

        <label class="section-title">Resulting Probability:</label>
        <input type="text" id="userProb" value="1.0000" readonly style="background:#f0f0f0; border-color:#ddd; text-align:right;">

        <div class="slider-label">
            <span>Map Opacity</span>
            <span id="opacityVal">70%</span>
        </div>
        <input type="range" id="opacitySlider" min="0" max="100" value="70">

        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <b style="color:#444;">Adjusted Legend</b>
            <div class="legend-grid" id="legend"></div>
        </div>
        <div id="status" style="margin-top:12px; font-size:10px; color:#888;">Initializing...</div>
    </div>
</div>

<script>
// ---------------- CONFIG ----------------
const PMTILES_FILE = "https://media.githubusercontent.com/media/gcf-mgb/Probabilistic_test/main/Temp_Prob_v2.pmtiles";
const SOURCE_LAYER = "slope_units";
const CSV_FILE = "probability_lookup_1_to_5000.csv"; 
let DETECTED_ID_FIELD = "OBJECTID1";

const RETURN_PERIODS = [
    { field: "prob_2",   label: "2 year RP" },
    { field: "prob_5",   label: "5 year RP" },
    { field: "prob_10",  label: "10 year RP" },
    { field: "prob_15",  label: "15 year RP" },
    { field: "prob_20",  label: "20 year RP" },
    { field: "prob_25",  label: "25 year RP" },
    { field: "prob_50",  label: "50 year RP" },
    { field: "prob_100", label: "100 year RP" }
];

const COLORS = ["#147218","#7CB815","#F2FE2A","#FFAC18","#FE3C19"];

const select = document.getElementById("returnPeriod");
const userArea = document.getElementById("userArea");
const userProb = document.getElementById("userProb");
const opacitySlider = document.getElementById("opacitySlider");
const opacityVal = document.getElementById("opacityVal");

// UI Toggle Function
function toggleMinimize() {
    const panel = document.getElementById("controlPanel");
    const btn = document.getElementById("minBtn");
    panel.classList.toggle("minimized");
    btn.innerText = panel.classList.contains("minimized") ? "+" : "−";
}

// ---------------- Logic Scripts ----------------
RETURN_PERIODS.forEach((r,i)=>{ 
    const o=document.createElement("option"); o.value=i; o.textContent=r.label; select.appendChild(o); 
});

let probLookup = {}; 
async function loadProbCSV() {
    try {
        const res = await fetch(CSV_FILE);
        const csvText = await res.text();
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    const area = parseFloat(row.Area_m2);
                    const prob = parseFloat(row["Probability_P(A_L_greater_than_Area)"]);
                    if(!isNaN(area) && !isNaN(prob)) probLookup[area] = prob;
                });
                document.getElementById("status").innerText = "✅ Data Ready";
                updateMap();
            }
        });
    } catch(err) { document.getElementById("status").innerText = "❌ CSV Error"; }
}

function computeUserProb() {
    let aL = parseFloat(userArea.value);
    if(aL <= 0 || isNaN(aL)) { userProb.value="1.0000"; return 1; }
    aL = Math.min(Math.max(aL, 1), 5000);
    const lower = Math.floor(aL);
    const upper = Math.ceil(aL);
    const pL = probLookup[lower] ?? 0;
    const pU = probLookup[upper] ?? pL;
    const prob = pL + (pU - pL) * (aL - lower);
    userProb.value = prob.toFixed(4);
    return prob;
}

function buildLegend() {
    const l = document.getElementById("legend");
    const labels = ["0–20%","20–40%","40–60%","60–80%","80–100%"];
    l.innerHTML = COLORS.map((c,i)=>`<div class="swatch" style="background:${c}"></div><div>${labels[i]}</div>`).join('');
}

function fillColor(field) {
    const m = computeUserProb();
    return ["step", ["*", ["coalesce", ["to-number", ["get", field]], 0], m],
        COLORS[0], 0.2, COLORS[1], 0.4, COLORS[2], 0.6, COLORS[3], 0.8, COLORS[4]
    ];
}

const protocol = new pmtiles.Protocol();
maplibregl.addProtocol("pmtiles", protocol.tile);
const p = new pmtiles.PMTiles(PMTILES_FILE);
protocol.add(p);

const map = new maplibregl.Map({
    container: "map",
    style: {
        version: 8,
        sources: {
            "google-satellite": {
                type: "raster", tiles: ["https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}"], 
                tileSize: 256, attribution: "Google"
            },
            hazard: { type: "vector", url: `pmtiles://${PMTILES_FILE}` }
        },
        layers: [
            { id: "satellite", type: "raster", source: "google-satellite" },
            {
                id: "haz_fill", type: "fill", source: "hazard", "source-layer": SOURCE_LAYER,
                paint: { "fill-color": COLORS[0], "fill-opacity": 0.7 }
            },
            {
                id: "haz_outline", type: "line", source: "hazard", "source-layer": SOURCE_LAYER,
                paint: { "line-color": "#00ffff", "line-width": 3, "line-opacity": 0 },
                filter: ["==", ["get", "NON_EXISTENT"], ""]
            }
        ]
    }
});

map.on("load", async () => {
    buildLegend();
    try {
        const h = await p.getHeader();
        map.fitBounds([[h.minLon, h.minLat], [h.maxLon, h.maxLat]], {padding: 30, duration: 0});
    } catch (e) {}
    await loadProbCSV();
});

function updateMap(){
    const rpField = RETURN_PERIODS[select.value].field;
    map.setPaintProperty("haz_fill", "fill-color", fillColor(rpField));
}

const popup = new maplibregl.Popup({closeButton: true, closeOnClick: true});

map.on("click", "haz_fill", (e) => {
    const props = e.features[0].properties;
    if(!(DETECTED_ID_FIELD in props)){
        const possibleFields = ["OBJECTID","FID","id","fid","id_0"];
        for(let f of possibleFields){ if(f in props){ DETECTED_ID_FIELD=f; break; } }
    }
    map.setFilter("haz_outline", ["==", ["get", DETECTED_ID_FIELD], props[DETECTED_ID_FIELD]]);
    map.setPaintProperty("haz_outline", "line-opacity", opacitySlider.value / 100);

    const m = computeUserProb();
    let html = `<div style="padding:5px; font-family:sans-serif; min-width:140px;">
        <b style="font-size:13px;">Adjusted Data</b><br>
        <small style="color:#777;">Multiplier: ${m.toFixed(4)}</small>
        <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
        <table style="font-size:11px; width:100%; border-collapse:collapse;">`;

    for(const r of RETURN_PERIODS){
        const val = (parseFloat(props[r.field]) || 0) * m * 100;
        html += `<tr style="border-bottom:1px solid #f9f9f9;">
                    <td style="padding:3px 0; color:#444;">${r.label}:</td>
                    <td style="text-align:right;"><b>${val.toFixed(4)}%</b></td>
                 </tr>`;
    }
    html += `</table></div>`;
    popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
});

popup.on('close', () => {
    map.setFilter("haz_outline", ["==", ["get", "NON_EXISTENT"], ""]);
    map.setPaintProperty("haz_outline", "line-opacity", 0);
});

select.onchange = updateMap;
userArea.oninput = updateMap;
opacitySlider.oninput = (e) => {
    const val = e.target.value / 100;
    map.setPaintProperty("haz_fill", "fill-opacity", val);
    opacityVal.innerText = e.target.value + "%";
};
</script>
</body>
</html>
