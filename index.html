<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Hazard Explorer - Ultra Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
html, body, #map { height:100%; margin:0; background:#000; overflow: hidden; }

.control {
    position:absolute; top:10px; left:10px; z-index:10;
    background:rgba(255,255,255,0.92); border-radius:10px;
    font:12px/1.2 system-ui, sans-serif;
    width:260px; box-shadow:0 2px 10px rgba(0,0,0,0.3);
    transition: all 0.2s ease-in-out;
}

.control-header {
    padding: 10px 12px; display: flex; justify-content: space-between;
    align-items: center; cursor: pointer;
}
.control-header b { font-size: 14px; }

.control-content {
    padding: 0 12px 12px 12px; 
    overflow-y: auto; 
    max-height: 70vh; /* Limits height on desktop */
}

/* Minimized Logic */
.control.minimized .control-content { display: none; }
.control.minimized { width: 150px; }

/* Mobile Portrait Optimization */
@media (max-width: 480px) {
    .control { 
        width: 92%; 
        left: 4%; 
        top: 8px; 
    }
    .control-content {
        max-height: 35vh; /* Panel will only occupy 35% of the screen height */
    }
    .section-title { margin-top: 6px; font-size: 11px; }
    select, input { padding: 6px; font-size: 13px; }
    .control.minimized { width: 140px; left: 10px; }
}

.section-title { font-weight:bold; color:#444; display:block; margin-top:10px; }
select, input { 
    width:100%; margin-top:4px; border:1px solid #ccc; 
    border-radius:5px; box-sizing:border-box;
}
.legend-grid { display:grid; grid-template-columns:18px 1fr; gap:4px 8px; margin-top:8px; font-size: 11px; }
.swatch { width:18px; height:12px; border-radius:2px; }
.slider-label { display:flex; justify-content:space-between; margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<div id="map"></div>

<div class="control" id="controlPanel">
    <div class="control-header" onclick="toggleMinimize()">
        <b>Hazard Explorer</b>
        <span id="minBtn" style="font-weight:bold; color:#888;">−</span>
    </div>
    
    <div class="control-content">
        <label class="section-title">Return Period:</label>
        <select id="returnPeriod"></select>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label class="section-title">Area (sqm):</label>
                <input type="number" id="userArea" value="0" step="0.1" min="0">
            </div>
            <div style="flex: 1;">
                <label class="section-title">Prob:</label>
                <input type="text" id="userProb" value="1.0000" readonly style="background:#f9f9f9; border:none; color:#d9534f; font-weight:bold;">
            </div>
        </div>

        <div class="slider-label">
            <span>Opacity</span>
            <span id="opacityVal">70%</span>
        </div>
        <input type="range" id="opacitySlider" min="0" max="100" value="70">

        <div style="margin-top:10px; border-top:1px solid #ddd; padding-top:8px;">
            <div class="legend-grid" id="legend"></div>
        </div>
        <div id="status" style="font-size:9px; color:#999; margin-top:5px;">Init...</div>
    </div>
</div>

<script>
// --- CONFIG (URLs & Layers) ---
const PMTILES_FILE = "https://media.githubusercontent.com/media/gcf-mgb/Probabilistic_test/main/Temp_Prob_v2.pmtiles";
const SOURCE_LAYER = "slope_units";
const CSV_FILE = "probability_lookup_1_to_5000.csv"; 
let DETECTED_ID_FIELD = "OBJECTID1";

const RETURN_PERIODS = [
    { field: "prob_2",   label: "2y RP" },
    { field: "prob_5",   label: "5y RP" },
    { field: "prob_10",  label: "10y RP" },
    { field: "prob_15",  label: "15y RP" },
    { field: "prob_20",  label: "20y RP" },
    { field: "prob_25",  label: "25y RP" },
    { field: "prob_50",  label: "50y RP" },
    { field: "prob_100", label: "100y RP" }
];
const COLORS = ["#147218","#7CB815","#F2FE2A","#FFAC18","#FE3C19"];

// --- UI Logic ---
const select = document.getElementById("returnPeriod");
const userArea = document.getElementById("userArea");
const userProb = document.getElementById("userProb");
const opacitySlider = document.getElementById("opacitySlider");
const opacityVal = document.getElementById("opacityVal");

function toggleMinimize() {
    const panel = document.getElementById("controlPanel");
    const btn = document.getElementById("minBtn");
    panel.classList.toggle("minimized");
    btn.innerText = panel.classList.contains("minimized") ? "+" : "−";
}

RETURN_PERIODS.forEach((r,i)=>{ 
    const o=document.createElement("option"); o.value=i; o.textContent=r.label; select.appendChild(o); 
});

let probLookup = {}; 
async function loadProbCSV() {
    try {
        const res = await fetch(CSV_FILE);
        const csvText = await res.text();
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    const area = parseFloat(row.Area_m2);
                    const prob = parseFloat(row["Probability_P(A_L_greater_than_Area)"]);
                    if(!isNaN(area) && !isNaN(prob)) probLookup[area] = prob;
                });
                document.getElementById("status").innerText = "✅ Ready";
                updateMap();
            }
        });
    } catch(err) { document.getElementById("status").innerText = "❌ CSV Error"; }
}

function computeUserProb() {
    let aL = parseFloat(userArea.value);
    if(aL <= 0 || isNaN(aL)) { userProb.value="1.0000"; return 1; }
    aL = Math.min(Math.max(aL, 1), 5000);
    const lower = Math.floor(aL);
    const upper = Math.ceil(aL);
    const pL = probLookup[lower] ?? 0;
    const pU = probLookup[upper] ?? pL;
    const prob = pL + (pU - pL) * (aL - lower);
    userProb.value = prob.toFixed(4);
    return prob;
}

function buildLegend() {
    const l = document.getElementById("legend");
    const labels = ["0–20%","20–40%","40–60%","60–80%","80–100%"];
    l.innerHTML = COLORS.map((c,i)=>`<div class="swatch" style="background:${c}"></div><div>${labels[i]}</div>`).join('');
}

function fillColor(field) {
    const m = computeUserProb();
    return ["step", ["*", ["coalesce", ["to-number", ["get", field]], 0], m],
        COLORS[0], 0.2, COLORS[1], 0.4, COLORS[2], 0.6, COLORS[3], 0.8, COLORS[4]
    ];
}

// --- MAP INIT ---
const protocol = new pmtiles.Protocol();
maplibregl.addProtocol("pmtiles", protocol.tile);
const p = new pmtiles.PMTiles(PMTILES_FILE);
protocol.add(p);

const map = new maplibregl.Map({
    container: "map",
    style: {
        version: 8,
        sources: {
            "google-satellite": {
                type: "raster", tiles: ["https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}"], 
                tileSize: 256, attribution: "Google"
            },
            hazard: { type: "vector", url: `pmtiles://${PMTILES_FILE}` }
        },
        layers: [
            { id: "satellite", type: "raster", source: "google-satellite" },
            {
                id: "haz_fill", type: "fill", source: "hazard", "source-layer": SOURCE_LAYER,
                paint: { "fill-color": COLORS[0], "fill-opacity": 0.7 }
            },
            {
                id: "haz_outline", type: "line", source: "hazard", "source-layer": SOURCE_LAYER,
                paint: { "line-color": "#00ffff", "line-width": 2, "line-opacity": 0 },
                filter: ["==", ["get", "NON_EXISTENT"], ""]
            }
        ]
    }
});

map.on("load", async () => {
    buildLegend();
    try {
        const h = await p.getHeader();
        map.fitBounds([[h.minLon, h.minLat], [h.maxLon, h.maxLat]], {padding: 20, duration: 0});
    } catch (e) {}
    await loadProbCSV();
});

function updateMap(){
    const rpField = RETURN_PERIODS[select.value].field;
    map.setPaintProperty("haz_fill", "fill-color", fillColor(rpField));
}

const popup = new maplibregl.Popup({closeButton: true, closeOnClick: true});

map.on("click", "haz_fill", (e) => {
    const props = e.features[0].properties;
    if(!(DETECTED_ID_FIELD in props)){
        const possibleFields = ["OBJECTID","FID","id","fid","id_0"];
        for(let f of possibleFields){ if(f in props){ DETECTED_ID_FIELD=f; break; } }
    }
    map.setFilter("haz_outline", ["==", ["get", DETECTED_ID_FIELD], props[DETECTED_ID_FIELD]]);
    map.setPaintProperty("haz_outline", "line-opacity", 1);

    const m = computeUserProb();
    let html = `<div style="font-size:11px; font-family:sans-serif;">
        <b>Adjusted Hazard</b><br>
        <table style="width:100%; border-collapse:collapse; margin-top:5px;">`;

    for(const r of RETURN_PERIODS){
        const val = (parseFloat(props[r.field]) || 0) * m * 100;
        html += `<tr style="border-bottom:1px solid #eee;">
                    <td>${r.label}:</td>
                    <td style="text-align:right;"><b>${val.toFixed(2)}%</b></td>
                 </tr>`;
    }
    html += `</table></div>`;
    popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
});

popup.on('close', () => {
    map.setFilter("haz_outline", ["==", ["get", "NON_EXISTENT"], ""]);
    map.setPaintProperty("haz_outline", "line-opacity", 0);
});

select.onchange = updateMap;
userArea.oninput = updateMap;
opacitySlider.oninput = (e) => {
    const val = e.target.value / 100;
    map.setPaintProperty("haz_fill", "fill-opacity", val);
    opacityVal.innerText = e.target.value + "%";
};
</script>
</body>
</html>
