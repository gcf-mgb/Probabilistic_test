<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Hazard Explorer - Dynamic Multiplier Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jstat@1.9.5/dist/jstat.min.js"></script>
<style>
html, body, #map { height:100%; margin:0; background:#000; }
.control {
    position:absolute; top:12px; left:12px; z-index:10;
    background:rgba(255, 255, 255, 0.95); border-radius:10px; padding:15px; 
    font:12px system-ui, sans-serif; width:280px; box-shadow:0 4px 15px rgba(0,0,0,0.5);
}
.legend-grid { display:grid; grid-template-columns:20px 1fr; gap:6px 10px; margin-top:10px; }
.swatch { width:20px; height:12px; border-radius:2px; border: 1px solid rgba(0,0,0,0.1); }
select, input { width: 100%; margin-top: 5px; cursor: pointer; box-sizing: border-box; padding:4px; }
.section-title { font-weight: bold; color: #444; display: block; margin-top: 12px; }
.slider-label { display: flex; justify-content: space-between; margin-top: 15px; font-weight: bold; color: #444; }
</style>
</head>
<body>
<div id="map"></div>
<div class="control">
    <b style="font-size: 15px;">Hazard Probability Explorer</b><br>

    <label class="section-title">Select Return Period:</label>
    <select id="returnPeriod"></select>

    <label class="section-title">User Landslide Area (sqm):</label>
    <input type="number" id="userArea" value="1000" step="1" min="0">

    <label class="section-title">Resulting Probability:</label>
    <input type="text" id="userProb" value="" readonly style="background:#eee; text-align:right;">

    <div class="slider-label">
        <span>Map Opacity</span>
        <span id="opacityVal">100%</span>
    </div>
    <input type="range" id="opacitySlider" min="0" max="100" value="100">

    <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
        <b style="color: #444;">Adjusted Probability Legend</b>
        <div class="legend-grid" id="legend"></div>
    </div>
    <div id="status" style="margin-top:12px; font-size:10px; color:#888;">Ready</div>
</div>

<script>
/* ==============================
   1. CONFIG & DATA SETTINGS
============================== */
const PMTILES_FILE = "https://media.githubusercontent.com/media/boyasboya23/test/main/Temp_Prob_v2.pmtiles";
const SOURCE_LAYER = "slope_units";
let DETECTED_ID_FIELD = "OBJECTID1";

const RETURN_PERIODS = [
    { field: "predicte_7", label: "2 year RP" }, { field: "predicte_8", label: "5 year RP" },
    { field: "predicte_9", label: "10 year RP" }, { field: "predict_10", label: "15 year RP" },
    { field: "predict_11", label: "20 year RP" }, { field: "predict_12", label: "25 year RP" },
    { field: "predict_13", label: "50 year RP" }, { field: "predict_14", label: "100 year RP" }
];

const COLORS = ["#147218", "#7CB815", "#F2FE2A", "#FFAC18", "#FE3C19"];
const BINS = [0, 0.2, 0.4, 0.6, 0.8, 1.01];

/* Inverse Gamma parameters (from Python fit) */
const IG_SHAPE = 1.7084;
const IG_LOC = -167.8416;
const IG_SCALE = 2753.7792;

/* ==============================
   2. PMTILES & MAP PROTOCOL
============================== */
const protocol = new pmtiles.Protocol();
maplibregl.addProtocol("pmtiles", protocol.tile);
const p = new pmtiles.PMTiles(PMTILES_FILE);
protocol.add(p);

/* ==============================
   3. UI ELEMENTS & COLOR LOGIC
============================== */
const select = document.getElementById("returnPeriod");
const userArea = document.getElementById("userArea");
const userProb = document.getElementById("userProb");
const opacitySlider = document.getElementById("opacitySlider");
const opacityVal = document.getElementById("opacityVal");

RETURN_PERIODS.forEach((r, i) => {
    const o = document.createElement("option");
    o.value = i; o.textContent = r.label;
    select.appendChild(o);
});

function computeUserProb() {
    const aL = parseFloat(userArea.value);
    if(aL <= IG_LOC) { userProb.value = "1.0000"; return 1; }
    const x = IG_SCALE / (aL - IG_LOC);
    const lower = jStat.gammap(IG_SHAPE, x); // regularized lower gamma
    const prob = 1 - lower; // upper gamma = P(A_L > aL)
    userProb.value = prob.toFixed(4);
    return prob;
}

// The core math: Value * Probability -> Match Color Bin
function fillColor(field) {
    const m = computeUserProb(); // use user probability as multiplier
    return ["step", 
        ["*", ["coalesce", ["to-number", ["get", field]], 0], m],
        COLORS[0], BINS[1], COLORS[1], BINS[2], COLORS[2], BINS[3], COLORS[3], BINS[4], COLORS[4]
    ];
}

function buildLegend() {
    const l = document.getElementById("legend");
    const labels = ["0–20%", "20–40%", "40–60%", "60–80%", "80–100%"];
    l.innerHTML = COLORS.map((c, i) => `<div class="swatch" style="background:${c}"></div><div>${labels[i]}</div>`).join('');
}

/* ==============================
   4. MAP INITIALIZATION
============================== */
const map = new maplibregl.Map({
    container: "map",
    style: {
        version: 8,
        sources: {
            "google-satellite": {
                type: "raster",
                tiles: ["https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}"],
                tileSize: 256,
                attribution: "Google"
            },
            hazard: { type: "vector", url: `pmtiles://${PMTILES_FILE}` }
        },
        layers: [
            { id: "satellite", type: "raster", source: "google-satellite" },
            {
                id: "haz_fill", 
                type: "fill", 
                source: "hazard", 
                "source-layer": SOURCE_LAYER,
                paint: { 
                    "fill-color": fillColor(RETURN_PERIODS[0].field), 
                    "fill-opacity": 1 
                }
            },
            {
                id: "haz_outline",
                type: "line",
                source: "hazard",
                "source-layer": SOURCE_LAYER,
                paint: {
                    "line-color": "#00ffff",
                    "line-width": 3,
                    "line-opacity": 0
                },
                filter: ["==", ["get", "NON_EXISTENT"], ""]
            }
        ]
    }
});

map.on("load", async () => {
    buildLegend();
    const h = await p.getHeader();
    map.fitBounds([[h.minLon, h.minLat], [h.maxLon, h.maxLat]], { padding: 50, duration: 0 });
});

/* ==============================
   5. INTERACTION & EVENTS
============================== */
const updateMap = () => {
    map.setPaintProperty("haz_fill", "fill-color", fillColor(RETURN_PERIODS[select.value].field));
};

select.onchange = updateMap;
userArea.oninput = updateMap;

opacitySlider.oninput = (e) => {
    const val = e.target.value / 100;
    map.setPaintProperty("haz_fill", "fill-opacity", val);
    map.setPaintProperty("haz_outline", "line-opacity", val);
    opacityVal.innerText = e.target.value + "%";
};

const popup = new maplibregl.Popup({ closeButton: true, closeOnClick: true });

map.on("click", "haz_fill", (e) => {
    const props = e.features[0].properties;
    
    // Auto-detect ID field if not set
    if (!(DETECTED_ID_FIELD in props)) {
        const possibleFields = ["OBJECTID", "FID", "id", "fid", "id_0"];
        for (let f of possibleFields) {
            if (f in props) { DETECTED_ID_FIELD = f; break; }
        }
    }

    // Highlight selected unit
    map.setFilter("haz_outline", ["==", ["get", DETECTED_ID_FIELD], props[DETECTED_ID_FIELD]]);

    let html = `<div style="padding:5px; font-family: sans-serif; min-width:160px;">
                  <b style="font-size:13px;">Adjusted Hazard Data</b><br>
                  <small style="color:#777;">Multiplier (from user area): ${computeUserProb().toFixed(4)}</small>
                  <hr style="margin: 5px 0; border:0; border-top:1px solid #eee;">
                  <table style="font-size:11px; width:100%; border-collapse:collapse;">`;
    for (const r of RETURN_PERIODS) {
        const raw = parseFloat(props[r.field]) || 0;
        const multiplied = (raw * computeUserProb() * 100).toFixed(2) + "%";
        html += `<tr style="border-bottom:1px solid #f9f9f9;">
                    <td style="padding:3px 0; color:#444;">${r.label}:</td>
                    <td style="text-align:right;"><b>${multiplied}</b></td>
                 </tr>`;
    }
    html += `</table></div>`;

    popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
});

popup.on('close', () => map.setFilter("haz_outline", ["==", ["get", "NON_EXISTENT"], ""]));
map.on("mouseenter", "haz_fill", () => map.getCanvas().style.cursor = "pointer");
map.on("mouseleave", "haz_fill", () => map.getCanvas().style.cursor = "");
</script>
</body>
</html>
